# é¡¹ç›®æ¶æ„ä¸åŠŸèƒ½å®ç°è¯´æ˜

## ğŸ—ï¸ æŠ€æœ¯æ ˆ

| å±‚ | æŠ€æœ¯ |
|---|------|
| åç«¯æ¡†æ¶ | Flask |
| å®æ—¶é€šä¿¡ | Flask-SocketIOï¼ˆWebSocketï¼‰ |
| æ•°æ®åº“ | SQLite3ï¼ˆWAL æ¨¡å¼ï¼Œ10s è¶…æ—¶ï¼‰ |
| å¯†ç å“ˆå¸Œ | argon2idï¼ˆç”¨æˆ·å¯†ç  + ç®¡ç†å‘˜å¯†ç ï¼‰ |
| ç”Ÿäº§ WSGI | gevent + gevent-websocket |
| å‰ç«¯ | åŸç”Ÿ HTML/CSS/JS + Socket.IO å®¢æˆ·ç«¯ |

---

## 1. ğŸ” ç”¨æˆ·è®¤è¯ï¼ˆæ³¨å†Œ/ç™»å½•ï¼‰

**æµç¨‹ï¼š**
- **æ³¨å†Œ**ï¼š`POST /api/register` â†’ æ ¡éªŒç”¨æˆ·åé•¿åº¦(2-20)å’Œå¯†ç é•¿åº¦(â‰¥4) â†’ `argon2id` å“ˆå¸Œå¯†ç  â†’ å†™å…¥ `users` è¡¨ï¼ˆargon2 è‡ªå¸¦ saltï¼Œæ— éœ€å•ç‹¬å­—æ®µï¼‰
- **ç™»å½•**ï¼š`POST /api/login` â†’ ä»æ•°æ®åº“å–å‡º `password_hash` â†’ `argon2.verify()` éªŒè¯ â†’ å†™å…¥ Flask `session`ï¼ˆå­˜ `user_id` + `username`ï¼‰
- **å°ç¦æ£€æŸ¥**ï¼š`before_request` é’©å­ä¸­æ¯ä¸ª `/api/` è¯·æ±‚éƒ½ä¼šæ£€æŸ¥ `is_banned` å­—æ®µï¼Œè¢«å°ç¦ç”¨æˆ·ç«‹å³æ¸…é™¤ session å¹¶è¿”å› 403
- **æ³¨å†Œå¼€å…³**ï¼šç®¡ç†å‘˜å¯é€šè¿‡ `system_settings` è¡¨çš„ `registration_enabled` å…³é—­æ³¨å†Œ

---

## 2. ğŸ’¬ ä¼šè¯ç³»ç»Ÿï¼ˆç§èŠ/ç¾¤èŠ/å¤‡å¿˜å½•ï¼‰

æ•°æ®åº“æœ‰ä¸‰å¼ æ ¸å¿ƒè¡¨ï¼š
- `conversations` â€” ä¼šè¯ï¼ˆå­—æ®µ `is_group`, `is_self_chat` åŒºåˆ†ç±»å‹ï¼‰
- `conversation_members` â€” æˆå‘˜å…³ç³»ï¼ˆå« `role`: admin/memberï¼‰
- `messages` â€” æ¶ˆæ¯

**ä¸‰ç§ä¼šè¯ç±»å‹ï¼š**

| ç±»å‹ | `is_group` | `is_self_chat` | åˆ›å»ºæ–¹å¼ |
|------|-----------|----------------|---------|
| ç§èŠ | 0 | 0 | `create_private_conversation()` â€” ç”¨ `BEGIN IMMEDIATE` é˜²ç«æ€é‡å¤åˆ›å»º |
| ç¾¤èŠ | 1 | 0 | `create_group_conversation()` â€” åˆ›å»ºè€…è‡ªåŠ¨è·å¾— `admin` è§’è‰² |
| å¤‡å¿˜å½• | 0 | 1 | `create_self_conversation()` â€” åŒæ ·ç”¨ `BEGIN IMMEDIATE` ä¿è¯å”¯ä¸€ |

**æƒé™æ§åˆ¶ï¼š**
- è¯»æ¶ˆæ¯å‰æ£€æŸ¥ `is_member(conv_id, user_id)`
- ç¾¤ç®¡ç†æ“ä½œï¼ˆæ”¹å/åŠ äºº/è¸¢äººï¼‰éœ€ `role='admin'` æˆ–ç¾¤ä¸»ï¼ˆ`created_by`ï¼‰
- ç¾¤ä¸»è½¬è®©ï¼š`transfer_group_owner()` â€” æ—§ç¾¤ä¸»é™ä¸º memberï¼Œæ–°ç¾¤ä¸»å‡ä¸º admin
- ç¾¤ä¸»ä¸èƒ½é€€ç¾¤ï¼Œå¿…é¡»å…ˆè½¬è®©

---

## 3. âš¡ å®æ—¶æ¶ˆæ¯ï¼ˆWebSocketï¼‰

**æœºåˆ¶ï¼š**
```
å®¢æˆ·ç«¯ Socket.IO  â†â†’  Flask-SocketIO æœåŠ¡ç«¯
```

- **è¿æ¥æ—¶**ï¼ˆ`on_connect`ï¼‰ï¼šå°†ç”¨æˆ· `sid` è®°å…¥ `online_users` å­—å…¸ï¼Œå¹¶ `join_room` åŠ å…¥æ‰€æœ‰ä¼šè¯æˆ¿é—´ï¼ˆ`conv_{id}`ï¼‰
- **å‘æ¶ˆæ¯**ï¼ˆ`on_send`ï¼‰ï¼š
  1. æ ¡éªŒï¼šæ˜¯å¦ç™»å½• â†’ æ˜¯å¦è¢«å°ç¦ â†’ `msg_type` ç™½åå• â†’ `media_url` æ‰€æœ‰æƒéªŒè¯ â†’ æ˜¯å¦æ˜¯ä¼šè¯æˆå‘˜ â†’ æ–‡æœ¬é•¿åº¦é™åˆ¶
  2. `db.save_message()` å†™å…¥æ•°æ®åº“
  3. `emit('new_message', ..., room=f'conv_{id}')` å¹¿æ’­ç»™æˆ¿é—´å†…æ‰€æœ‰æˆå‘˜
- **æ–­å¼€æ—¶**ï¼ˆ`on_disconnect`ï¼‰ï¼šä» `online_users` ç§»é™¤ sid

**å‰ç«¯**ï¼šæ”¶åˆ° `new_message` äº‹ä»¶åè¿½åŠ æ¶ˆæ¯æ°”æ³¡å¹¶æ»šåŠ¨åˆ°åº•éƒ¨ã€‚

---

## 4. ğŸ”” æ¶ˆæ¯å¼¹å‡ºé€šçŸ¥

å‰ç«¯å®ç°ï¼ˆ`chat.js`ï¼‰ï¼š
- å…¨å±€å˜é‡ `notificationsEnabled` æ§åˆ¶å¼€å…³
- æ”¶åˆ° `new_message` æ—¶ï¼Œå¦‚æœæ¶ˆæ¯ä¸æ˜¯è‡ªå·±å‘çš„ï¼Œä¸”å½“å‰ä¸åœ¨è¯¥ä¼šè¯æˆ–é¡µé¢ä¸å¯è§ï¼Œåˆ™è°ƒç”¨ `showToast()` åœ¨å³ä¸Šè§’æ˜¾ç¤ºå¼¹å‡ºé€šçŸ¥
- Toast 5ç§’è‡ªåŠ¨æ¶ˆå¤±ï¼Œç‚¹å‡»å¯è·³è½¬åˆ°å¯¹åº”ä¼šè¯
- é€šè¿‡ä¾§è¾¹æ  ğŸ”” æŒ‰é’®åˆ‡æ¢å¼€å…³

---

## 5. ğŸ“ æ–‡ä»¶ä¸Šä¼ ä¸å­˜å‚¨é…é¢

**ä¸Šä¼ æµç¨‹ï¼š**
```
å‰ç«¯é€‰æ–‡ä»¶ â†’ POST /api/upload â†’ æœåŠ¡ç«¯æ ¡éªŒå¤§å°/ç±»å‹ â†’ uuidé‡å‘½åå­˜ç›˜
â†’ BEGIN IMMEDIATE åŸå­é…é¢æ£€æŸ¥+è®°å½• â†’ è¿”å› URL
â†’ å‰ç«¯é€šè¿‡ WebSocket send_message å‘é€ media_url
```

**å®‰å…¨æªæ–½ï¼š**
- æ–‡ä»¶åç”¨ `uuid4().hex` é‡å‘½åï¼Œé˜²æ­¢è·¯å¾„éå†
- `_save_upload` æ ¡éªŒ `sub_dir` ä¸å« `..`/`/`/`\`
- SVG å·²ä»å…è®¸åˆ—è¡¨ç§»é™¤ï¼ˆé˜² XSSï¼‰
- `media_url` åœ¨ `send_message` ä¸­ä¸‰é‡æ ¡éªŒï¼šå‰ç¼€å¿…é¡»æ˜¯ `/static/uploads/`ã€ä¸å« `..`ã€æ•°æ®åº“ä¸­æœ‰å½“å‰ç”¨æˆ·çš„æ‰€æœ‰æƒè®°å½•

**å­˜å‚¨é…é¢ç³»ç»Ÿï¼š**
- `user_files` è¡¨è®°å½•æ¯ä¸ªç”¨æˆ·çš„æ¯ä¸ªä¸Šä¼ æ–‡ä»¶åŠå¤§å°
- `record_file_upload()` ä½¿ç”¨ `BEGIN IMMEDIATE` äº‹åŠ¡åŸå­åœ°åš `SUM(file_size)` + é…é¢æ¯”å¯¹ + INSERT
- é…é¢ä¼˜å…ˆçº§ï¼šç”¨æˆ·ä¸ªäººé…é¢ (`user_profiles.storage_quota_mb`) > å…¨å±€é»˜è®¤é…é¢ (`system_settings.default_storage_quota_mb`ï¼Œé»˜è®¤10GB)

---

## 6. ğŸ‘¤ ä¸ªäººèµ„æ–™ä¸è®¾ç½®

`user_profiles` è¡¨å­˜å‚¨ï¼š
- `avatar_emoji` â€” é»˜è®¤ ğŸ˜Šï¼Œå‰ç«¯æ˜¾ç¤ºä¸ºå¤´åƒ
- `avatar_url` â€” ä¸Šä¼ çš„è‡ªå®šä¹‰å¤´åƒå›¾ç‰‡è·¯å¾„ï¼ˆå†™å…¥å‰æ ¡éªŒè·¯å¾„åˆæ³•æ€§+æ‰€æœ‰æƒï¼‰
- `bio` â€” ä¸ªæ€§ç­¾åï¼ˆâ‰¤100å­—ç¬¦ï¼‰
- `theme` â€” ä¸»é¢˜ï¼ˆlight/darkï¼‰
- `font_size` â€” å­—ä½“å¤§å°ï¼ˆsmall/medium/largeï¼‰

ä¿®æ”¹å¯†ç ï¼š`change_password()` â†’ argon2 éªŒè¯æ—§å¯†ç  â†’ å“ˆå¸Œæ–°å¯†ç  â†’ æ›´æ–°æ•°æ®åº“ â†’ æ¸…é™¤ session å¼ºåˆ¶é‡æ–°ç™»å½•

---

## 7. ğŸ‘¥ å¥½å‹ç³»ç»Ÿ

**æ•°æ®ç»“æ„ï¼š** `friends` è¡¨ï¼Œæ ‡å‡†åŒ–å­˜å‚¨ `(min(A,B), max(A,B))`ï¼ŒUNIQUE çº¦æŸé˜²å¹¶å‘é‡å¤ã€‚`initiated_by` è®°å½•è°å‘èµ·çš„è¯·æ±‚ã€‚

| æ“ä½œ | å®ç° |
|------|------|
| å‘è¯·æ±‚ | `send_friend_request()` â€” å¦‚æœå¯¹æ–¹å·²å‘ä½ å‘è¯·æ±‚åˆ™è‡ªåŠ¨åŒæ„ |
| æ¥å— | `accept_friend_request()` â€” æ ¡éªŒ `initiated_by != user_id`ï¼ˆåªæœ‰è¢«è¯·æ±‚æ–¹èƒ½æ¥å—ï¼‰ |
| æ‹’ç» | `reject_friend_request()` â€” åˆ é™¤è®°å½• |
| åˆ å¥½å‹ | `remove_friend()` â€” ç›´æ¥åˆ  |
| å®æ—¶é€šçŸ¥ | å‘è¯·æ±‚æˆåŠŸåé€šè¿‡ `online_users` æŸ¥æ‰¾ç›®æ ‡ sidï¼Œemit `friend_request` äº‹ä»¶ |

ç®¡ç†å‘˜å¯é€šè¿‡ `system_settings.allow_friend_requests` å…¨å±€å…³é—­å¥½å‹åŠŸèƒ½ã€‚

---

## 8. ğŸ”’ ç®¡ç†åå°

**è®¤è¯ï¼š** ç‹¬ç«‹äºç”¨æˆ·ç³»ç»Ÿï¼Œå¯†ç å­˜åœ¨ `admin_config.json`ï¼ˆargon2id å“ˆå¸Œï¼‰ï¼Œé€šè¿‡ `admin_setup.py` äº¤äº’å¼è®¾ç½®ã€‚ç™»å½•å session è®¾ç½® `is_admin=True`ï¼Œ`require_admin` è£…é¥°å™¨ä¿æŠ¤æ‰€æœ‰ç®¡ç† APIã€‚

**åŠŸèƒ½ï¼š**

| åŠŸèƒ½ | API | è¯´æ˜ |
|------|-----|------|
| ç”¨æˆ·åˆ—è¡¨ | `GET /api/admin/users` | å« IDã€ç”¨æˆ·åã€æ³¨å†Œæ—¶é—´ã€å°ç¦çŠ¶æ€ã€å­˜å‚¨ç”¨é‡ |
| åˆ›å»ºç”¨æˆ· | `POST /api/admin/users` | ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»º |
| åˆ é™¤ç”¨æˆ· | `DELETE /api/admin/users/:id` | è‡ªåŠ¨è½¬è®©ç¾¤ä¸»ã€æ¸…ç†å­¤ç«‹ä¼šè¯/æ¶ˆæ¯ |
| å°ç¦/è§£å° | `PUT /api/admin/users/:id/ban` | è®¾ç½® `is_banned`ï¼Œç”Ÿæ•ˆåè¢«å°ç”¨æˆ·æ‰€æœ‰ API ç«‹å³è¢«æ‹¦æˆª |
| è®¾ç½®é…é¢ | `PUT /api/admin/users/:id/quota` | å•ç”¨æˆ·å­˜å‚¨é…é¢è¦†ç›– |
| ç¾¤èŠç®¡ç† | `GET/PUT/DELETE /api/admin/groups` | æŸ¥çœ‹ã€æ”¹åã€åˆ é™¤ç¾¤èŠ |
| ç³»ç»Ÿè®¾ç½® | `PUT /api/admin/system-settings` | æ³¨å†Œå¼€å…³ã€æ¶ˆæ¯é•¿åº¦ä¸Šé™ã€ç³»ç»Ÿåç§°ã€å¥½å‹å¼€å…³ã€é»˜è®¤é…é¢ |
| ç»Ÿè®¡é¢æ¿ | `GET /api/admin/stats` | ç”¨æˆ·æ•°ã€ç¾¤æ•°ã€æ¶ˆæ¯æ•°ã€24h æ´»è·ƒç”¨æˆ· |

---

## 9. ğŸ—„ï¸ æ•°æ®åº“ç®¡ç†

- **è¿æ¥ç®¡ç†**ï¼š`db_conn()` ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¿è¯æ¯æ¬¡æ“ä½œåè‡ªåŠ¨å…³é—­è¿æ¥
- **åˆå§‹åŒ–**ï¼š`init_db()` ä½¿ç”¨åŒé‡æ£€æŸ¥é”ï¼ˆ`_db_init_lock` + `_db_initialized`ï¼‰ä¿è¯åªæ‰§è¡Œä¸€æ¬¡
- **è¿ç§»ç³»ç»Ÿ**ï¼š`system_settings.db_version` è®°å½•ç‰ˆæœ¬å·ï¼Œ`_init_db_locked()` ä¸­æŒ‰ç‰ˆæœ¬å·è¿è¡Œå¢é‡è¿ç§»
- **å¹‚ç­‰åˆ—æ·»åŠ **ï¼š`_safe_add_column()` ç”¨ try/except å¿½ç•¥å·²å­˜åœ¨çš„åˆ—ï¼Œä¿è¯é‡å¤å¯åŠ¨ä¸æŠ¥é”™
