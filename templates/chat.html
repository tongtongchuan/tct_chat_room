<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天室</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <!-- Toast notifications -->
    <div id="toastContainer"></div>

    <div class="app">
        <aside class="left-rail">
            <button class="rail-btn active" id="nav-messages" title="消息" onclick="switchSidebarTab('chats')"><i data-lucide="message-circle"></i></button>
            <button class="rail-btn" id="nav-contacts" title="通讯录" onclick="switchSidebarTab('contacts')"><i data-lucide="users"></i></button>
            <button class="rail-btn" id="nav-favorites" title="收藏" onclick="switchSidebarTab('favorites')"><i data-lucide="star"></i></button>
        </aside>
        <!-- Drag-drop overlay -->
        <div id="dropOverlay" class="drop-overlay" style="display:none">
            <div class="drop-content">
                <div style="font-size:48px"><i data-lucide="paperclip"></i></div>
                <div style="font-size:18px;margin-top:8px">松开以发送文件</div>
            </div>
        </div>
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="user-info" style="cursor:pointer" onclick="openSettings('profile')" title="点击查看个人资料">
                    <span class="avatar" id="myAvatar"></span>
                    <span class="username" id="myName"></span>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" title="消息通知" id="toggleNotif" onclick="toggleNotifications()"><i data-lucide="bell"></i></button>
                    <button class="icon-btn" title="设置" onclick="openSettings('profile')"><i data-lucide="settings"></i></button>
                    <button class="icon-btn" title="退出" onclick="doLogout()"><i data-lucide="log-out"></i></button>
                </div>
            </div>

            <!-- Chats Panel -->
            <div id="panel-chats" style="flex:1; display:flex; flex-direction:column; overflow:hidden; min-height:0;">
                <div class="sidebar-actions">
                    <button class="action-btn" onclick="openSelfChat()" title="我的备忘录"><i data-lucide="notebook-pen"></i>备忘录</button>
                    <button class="action-btn" onclick="showModal('newChat')">新对话</button>
                    <button class="action-btn" onclick="showModal('newGroup')">创建群聊</button>
                </div>
                <div class="conv-list" id="convList">
                    <div class="empty-hint">暂无会话，点击上方开始聊天</div>
                </div>
            </div>

            <!-- Contacts Panel -->
            <div id="panel-contacts" style="display:none; flex:1; overflow:hidden; display:none; flex-direction:column">
                <div class="sidebar-actions">
                    <button class="action-btn" onclick="showModal('addFriend')">添加好友</button>
                    <button class="action-btn" onclick="showModal('friendReview')">好友审核</button>
                </div>
                <!-- Friend Requests -->
                <div id="friendRequestsSection" style="display:none">
                    <div class="contacts-section-title" onclick="toggleFriendRequests()">
                        新的朋友
                        <span class="badge" id="reqBadge"></span>
                        <span id="reqChevron" style="margin-left:auto">▼</span>
                    </div>
                    <div id="friendRequestsList"></div>
                </div>
                <!-- Friends List -->
                <div class="contacts-section-title">我的好友</div>
                <div class="contacts-list" id="friendsList">
                    <div class="empty-hint">暂无好友，点击上方添加</div>
                </div>
            </div>

            <!-- Favorites Panel -->
            <div id="panel-favorites" style="display:none; flex:1; overflow:hidden; flex-direction:column">
                <div class="sidebar-actions">
                    <button class="action-btn" onclick="loadFavorites()">刷新收藏</button>
                </div>
                <div class="conv-list" id="favoritesList">
                    <div class="empty-hint">暂无收藏消息</div>
                </div>
                <button class="load-more" id="favoritesLoadMoreBtn" onclick="loadFavoritesMore()" style="display:none; margin:8px 10px 10px;">加载更多收藏</button>
            </div>
        </aside>

        <!-- Chat area -->
        <main class="chat-area">
            <div class="chat-placeholder" id="chatPlaceholder">
                <div class="placeholder-icon"><i data-lucide="message-square"></i></div>
                <p>选择一个会话开始聊天</p>
            </div>
            <div class="chat-container" id="chatContainer" style="display:none">
                <div class="chat-header">
                    <span class="chat-title-avatar" id="chatTitleAvatar"></span>
                    <span class="chat-title" id="chatTitle"></span>
                    <span class="chat-members" id="chatMembers"></span>
                    <div style="margin-left:auto; display:flex; gap:4px">
                        <button class="icon-btn" id="multiSelectBtn" title="多选转发" onclick="toggleSelectionMode()"><i data-lucide="check-square"></i></button>
                        <button class="icon-btn" id="forwardSelectedBtn" title="转发选中" onclick="forwardSelectedMessages()" style="display:none"><i data-lucide="forward"></i></button>
                        <button class="icon-btn" id="groupSettingsBtn" title="群聊设置"
                                onclick="openGroupSettings()" style="display:none"><i data-lucide="sliders-horizontal"></i></button>
                    </div>
                </div>
                <div class="group-announcement" id="groupAnnouncement" style="display:none"></div>
                <div class="pinned-strip" id="pinnedStrip" style="display:none"></div>
                <div class="messages" id="messages">
                    <button class="load-more" id="loadMoreBtn" onclick="loadMore()" style="display:none">加载更多</button>
                </div>
                <div class="input-area">
                    <div id="replyContainer" class="reply-container" style="display:none">
                        <div class="reply-info">
                            <i data-lucide="reply" class="reply-icon"></i>
                            <div class="reply-content">
                                <div id="replyToUser" class="reply-user"></div>
                                <div id="replyToText" class="reply-text"></div>
                            </div>
                        </div>
                        <button class="icon-btn" onclick="cancelReply()"><i data-lucide="x"></i></button>
                    </div>
                    <div class="input-toolbar">
                        <button class="toolbar-btn" title="发送图片/文件" onclick="document.getElementById('fileInput').click()"><i data-lucide="paperclip"></i></button>
                        <input type="file" id="fileInput" style="display:none"
                               accept="image/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar,.7z,.md"
                               onchange="handleFileSelect(this)">
                        <button class="toolbar-btn" id="recordBtn" title="录音模式" onclick="toggleRecordMode()"><i data-lucide="mic"></i></button>
                        <button class="toolbar-btn" id="speechBtn" title="语音识别" onclick="toggleSpeech()"><i data-lucide="audio-lines"></i></button>
                    </div>
                    <div class="input-row">
                        <textarea id="msgInput" placeholder="输入消息… (Enter 发送, Shift+Enter 换行)" onkeydown="handleKey(event)"></textarea>
                        <button class="hold-record-btn" id="holdRecordBtn" style="display:none"
                                onmousedown="startHoldRecord(event)" onmouseup="stopHoldRecord(event)"
                                onmouseleave="cancelHoldRecord(event)" ontouchstart="startHoldRecord(event)"
                                ontouchend="stopHoldRecord(event)" ontouchcancel="cancelHoldRecord(event)">
                            按住录音
                        </button>
                        <button class="send-btn" onclick="sendMessage()">发送</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Group Settings Panel -->
        <aside class="group-settings-panel" id="groupSettingsPanel" style="display:none">
            <div class="gsp-header">
                <span>群聊设置</span>
                <button class="icon-btn" onclick="closeGroupSettings()"><i data-lucide="x"></i></button>
            </div>
            <div class="gsp-body" id="gspBody"></div>
        </aside>
    </div>

    <div class="context-menu" id="contextMenu" style="display:none"></div>

    <!-- New Chat Modal -->
    <div class="modal-overlay" id="modal-newChat" onclick="hideModal(event, 'newChat')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>新建私聊</h3>
            <input type="text" id="searchUserInput" placeholder="搜索用户名..." oninput="searchUsers()">
            <div class="search-results" id="searchResults"></div>
            <button class="modal-close" onclick="hideModal(null, 'newChat')">取消</button>
        </div>
    </div>

    <!-- New Group Modal -->
    <div class="modal-overlay" id="modal-newGroup" onclick="hideModal(event, 'newGroup')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>创建群聊</h3>
            <input type="text" id="groupName" placeholder="群名称">
            <input type="text" id="searchGroupUserInput" placeholder="搜索用户添加..." oninput="searchGroupUsers()">
            <div class="search-results" id="groupSearchResults"></div>
            <div class="selected-members" id="selectedMembers"></div>
            <button class="btn-primary" onclick="createGroup()">创建</button>
            <button class="modal-close" onclick="hideModal(null, 'newGroup')">取消</button>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div class="modal-overlay" id="modal-addFriend" onclick="hideModal(event, 'addFriend')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>添加好友</h3>
            <input type="text" id="searchFriendInput" placeholder="搜索用户名..." oninput="searchFriendUsers()">
            <div class="search-results" id="friendSearchResults"></div>
            <button class="modal-close" onclick="hideModal(null, 'addFriend')">关闭</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal" onclick="closeSettingsIfOverlay(event)">
        <div class="settings-dialog" onclick="event.stopPropagation()">
            <div class="settings-sidebar">
                <div class="settings-user">
                    <span class="avatar" id="settingsAvatar" style="width:48px;height:48px;font-size:20px"></span>
                    <span id="settingsUsername"></span>
                </div>
                <button class="settings-nav-item active" id="snav-profile" onclick="switchSettingsTab('profile')"><i data-lucide="user-round"></i>个人资料</button>
                <button class="settings-nav-item" id="snav-security" onclick="switchSettingsTab('security')"><i data-lucide="shield-check"></i>账号安全</button>
                <button class="settings-nav-item" id="snav-appearance" onclick="switchSettingsTab('appearance')"><i data-lucide="palette"></i>个性化</button>
                <button class="settings-nav-item" id="snav-notification" onclick="switchSettingsTab('notification')"><i data-lucide="bell-ring"></i>通知设置</button>
                <button class="settings-nav-item" id="snav-storage" onclick="switchSettingsTab('storage')"><i data-lucide="hard-drive"></i>云存储</button>
            </div>
            <div class="settings-content">
                <button class="icon-btn" style="position:absolute;top:14px;right:14px" onclick="closeSettings()"><i data-lucide="x"></i></button>

                <!-- Profile Tab -->
                <div class="settings-tab" id="stab-profile">
                    <h2 class="settings-title">个人资料</h2>
                    <div class="settings-group">
                        <label class="settings-label">头像</label>
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
                            <span class="avatar" id="previewAvatar" style="width:52px;height:52px;font-size:22px;overflow:hidden;border-radius:50%"></span>
                            <div>
                                <div style="font-size:12px;color:var(--text-3);margin-bottom:6px">上传自定义头像（最大5MB）</div>
                                <label class="avatar-upload-btn">
                                    选择图片
                                    <input type="file" id="avatarFileInput" accept="image/*"
                                           style="display:none" onchange="uploadAvatar(this)">
                                </label>
                                <button class="avatar-upload-btn danger" onclick="clearAvatarUrl()" style="margin-left:6px">
                                    清除图片头像
                                </button>
                            </div>
                        </div>
                        <div class="avatar-picker" id="avatarPicker"></div>
                    </div>
                    <div class="settings-group">
                        <label class="settings-label">用户名</label>
                        <div class="settings-value" id="profileUsername"></div>
                    </div>
                    <div class="settings-group">
                        <label class="settings-label">个性签名</label>
                        <textarea class="settings-textarea" id="profileBio" placeholder="介绍一下自己..." maxlength="100"></textarea>
                    </div>
                    <button class="btn-save" onclick="saveProfile()">保存修改</button>
                </div>

                <!-- Security Tab -->
                <div class="settings-tab" id="stab-security" style="display:none">
                    <h2 class="settings-title">账号安全</h2>
                    <div class="settings-group">
                        <label class="settings-label">修改密码</label>
                        <input type="password" class="settings-input" id="oldPassword" placeholder="当前密码">
                        <input type="password" class="settings-input" id="newPassword" placeholder="新密码（至少4位）" style="margin-top:8px">
                        <input type="password" class="settings-input" id="newPassword2" placeholder="确认新密码" style="margin-top:8px">
                    </div>
                    <button class="btn-save" onclick="savePassword()">修改密码</button>
                    <div style="margin-top:24px; padding-top:16px; border-top:1px solid var(--border)">
                        <label class="settings-label">登录会话</label>
                        <p style="color:var(--text-3);font-size:13px;margin-top:4px">修改密码后将自动退出所有设备</p>
                    </div>
                </div>

                <!-- Appearance Tab -->
                <div class="settings-tab" id="stab-appearance" style="display:none">
                    <h2 class="settings-title">个性化</h2>
                    <div class="settings-group">
                        <label class="settings-label">主题</label>
                        <div class="theme-options">
                            <div class="theme-option" id="theme-light" onclick="setTheme('light')">
                                <div class="theme-preview light-preview"></div>
                                <span>浅色</span>
                            </div>
                            <div class="theme-option" id="theme-dark" onclick="setTheme('dark')">
                                <div class="theme-preview dark-preview"></div>
                                <span>深色</span>
                            </div>
                        </div>
                    </div>
                    <div class="settings-group">
                        <label class="settings-label">字体大小</label>
                        <div class="font-size-options">
                            <button class="font-opt" id="font-small" onclick="setFontSize('small')">小</button>
                            <button class="font-opt" id="font-medium" onclick="setFontSize('medium')">中</button>
                            <button class="font-opt" id="font-large" onclick="setFontSize('large')">大</button>
                        </div>
                        <p class="settings-preview-text" id="fontPreview">这是字体预览文字</p>
                    </div>
                    <button class="btn-save" onclick="saveAppearance()">保存</button>
                </div>

                <!-- Notification Tab -->
                <div class="settings-tab" id="stab-notification" style="display:none">
                    <h2 class="settings-title">通知设置</h2>
                    <div class="settings-group">
                        <div class="settings-toggle-row">
                            <div>
                                <div class="settings-label">消息通知</div>
                                <div style="color:var(--text-3);font-size:12px;margin-top:2px">收到新消息时显示弹窗提醒</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="notifToggle" onchange="toggleNotifSetting()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-toggle-row" style="margin-top:12px">
                            <div>
                                <div class="settings-label">好友请求通知</div>
                                <div style="color:var(--text-3);font-size:12px;margin-top:2px">收到好友请求时显示提醒</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="friendReqNotifToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Storage Tab -->
                <div class="settings-tab" id="stab-storage" style="display:none">
                    <h2 class="settings-title">云存储</h2>
                    <div class="settings-group">
                        <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px">
                            <label class="settings-label" style="margin-bottom:0">存储用量</label>
                            <span id="storageText" style="font-size:12px;color:var(--text-3)">加载中...</span>
                        </div>
                        <div style="height:10px;background:var(--bg);border-radius:5px;overflow:hidden;border:1px solid var(--border)">
                            <div id="storageBar" style="height:100%;width:0%;background:var(--primary);border-radius:5px;transition:width 0.4s"></div>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-top:5px">
                            <span id="storageUsed" style="font-size:11px;color:var(--text-3)"></span>
                            <span id="storageQuota" style="font-size:11px;color:var(--text-3)"></span>
                        </div>
                    </div>
                    <div class="settings-group">
                        <label class="settings-label">上传说明</label>
                        <p style="font-size:13px;color:var(--text-3);line-height:1.6">
                            支持上传任意类型文件（图片、音频、视频、文档等）。<br>
                            单次最大 <strong id="maxUploadMb">100</strong> MB，个人总配额 <strong id="quotaMbLabel">-</strong> GB。<br>
                            配额用满后无法继续上传，可联系管理员调整。
                        </p>
                    </div>
                    <button class="btn-save" onclick="loadStorageInfo()">刷新用量</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-friendReview" onclick="hideModal(event, 'friendReview')">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>好友审核</h3>
            <div class="contacts-section-title">收到的申请</div>
            <div class="search-results" id="friendReviewIncoming"></div>
            <div class="contacts-section-title" style="margin-top:12px">我发出的申请</div>
            <div class="search-results" id="friendReviewOutgoing"></div>
            <button class="modal-close" onclick="hideModal(null, 'friendReview')">关闭</button>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js" integrity="sha256-rVL8VAaAlF/nVJwPGxEmtUAp3X6yX4zisHmmJCyAcBE=" crossorigin="anonymous"></script>
    <script src="/static/js/chat.js"></script>
</body>
</html>
